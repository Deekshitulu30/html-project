<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Examination Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .radio-dot { transform: scale(0); transition: transform 0.2s ease-in-out; }
        .peer:checked + div .radio-dot { transform: scale(1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg"><i class="fas fa-graduation-cap text-xl"></i></div>
                <h1 class="text-xl font-bold text-gray-900">DSK Exams</h1>
            </div>
            <div id="timer-display" class="hidden flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full border border-gray-200">
                <i class="fas fa-clock text-blue-600"></i>
                <span id="time-left" class="font-mono font-semibold text-lg text-gray-700">15:00</span>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-3xl w-full mx-auto px-4 py-8">
        <div id="view-instructions" class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden fade-in">
            <div class="bg-blue-50 p-6 border-b border-blue-100">
                <h2 class="text-2xl font-bold text-blue-900">Examination Instructions</h2>
                <p class="text-blue-700 mt-2">Please read carefully before starting.</p>
            </div>
            <div class="p-8 space-y-6">
                <div class="space-y-4">
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">1</div>
                        <p class="mt-1 text-gray-600">The exam consists of <strong class="text-gray-900">15 questions</strong> randomly selected from our question bank.</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">3</div>
                        <p class="mt-1 text-gray-600">You have <strong class="text-gray-900">15 minutes</strong> to complete the examination.</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">4</div>
                        <p class="mt-1 text-gray-600">Each question has only one correct answer.</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">5</div>
                        <p class="mt-1 text-gray-600">Once submitted, you cannot change your answers. The test will auto-submit if the timer runs out.</p>
                    </div>
                </div>

                <div class="pt-6 border-t border-gray-100">
                    <button onclick="startExam()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-md transition transform hover:scale-[1.01] active:scale-[0.99] flex justify-center items-center gap-2">
                        <span>Start Examination</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="view-quiz" class="hidden space-y-6">
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="questions-container" class="space-y-6"></div>
            <div class="pt-6 flex justify-between gap-4">
                <button id="btn-prev" onclick="prevQuestion()" class="w-1/2 bg-gray-200 text-gray-700 font-bold py-4 px-6 rounded-lg">Previous</button>
                <button id="btn-next" onclick="nextQuestion()" class="w-1/2 bg-blue-600 text-white font-bold py-4 px-6 rounded-lg">Next</button>
                <button id="btn-submit" onclick="submitExam()" class="hidden w-1/2 bg-green-600 text-white font-bold py-4 px-6 rounded-lg">Submit</button>
            </div>
        </div>

        <div id="view-results" class="hidden fade-in">
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden text-center p-8">
                <div id="score-icon-container" class="w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-4"></div>
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Exam Completed!</h2>
                <p id="result-message" class="text-gray-600 mb-6"></p>
                <div class="flex justify-center gap-8 mb-8">
                    <div class="text-center"><span class="block text-sm text-gray-500">Score</span><span id="final-score" class="text-4xl font-bold text-blue-600">0%</span></div>
                    <div class="text-center"><span class="block text-sm text-gray-500">Correct</span><span id="correct-count" class="text-4xl font-bold text-green-600">0/15</span></div>
                </div>
                <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition">Take New Exam</button>
            </div>
            <div class="mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 px-2">Detailed Review</h3>
                <div id="review-container" class="space-y-4"></div>
            </div>
        </div>
    </main>

    <script>
        // GLOBAL VARIABLES
        let questionBank = [];
        let currentQuestions = [];
        let userAnswers = {};
        let timerInterval;
        let timeLeft = 15 * 60;
        let currentQuestionIndex = 0;

        // 1. FETCH QUESTIONS.JSON
        fetch("questions.json")
            .then(response => {
                if (!response.ok) {
                    throw new Error("HTTP Error " + response.status);
                }
                return response.json();
            })
            .then(data => {
                // DATA LOADED SUCCESSFULLY
                questionBank = data.map(q => {
                    return {
                        ...q,
                        // Convert numeric answer index to actual string text
                        correctAnswerText: q.options[q.answer] 
                    };
                });
                
                // ENABLE THE START BUTTON
                const btn = document.getElementById('btn-start-exam');
                const btnText = document.getElementById('btn-text');
                const icon = btn.querySelector('i');
                
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'transform', 'hover:scale-[1.01]');
                btnText.textContent = "Start Examination";
                icon.className = "fas fa-arrow-right";
                
                console.log("Questions loaded:", questionBank.length);
            })
            .catch(error => {
                console.error("Fetch Error:", error);
                document.getElementById('error-msg').classList.remove('hidden');
                document.getElementById('btn-text').textContent = "Failed to Load";
            });

        // 2. HELPER: ESCAPE HTML (Fixes invisible options like <h1>)
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 3. START EXAM LOGIC
        function startExam() {
            if (questionBank.length === 0) return;

            const shuffled = shuffleArray([...questionBank]); 
            currentQuestions = shuffled.slice(0, 15);
            
            currentQuestions.forEach(q => {
                q.shuffledOptions = shuffleArray([...q.options]);
            });

            userAnswers = {};
            currentQuestionIndex = 0;
            
            renderQuestion();
            
            document.getElementById('view-instructions').classList.add('hidden');
            document.getElementById('view-quiz').classList.remove('hidden');
            document.getElementById('timer-display').classList.remove('hidden');
            document.getElementById('timer-display').classList.add('flex');
            
            // Timer Logic
            const timerEl = document.getElementById('time-left');
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                timerEl.textContent = `${m}:${s}`;

                if(timeLeft < 60) timerEl.classList.add('text-red-600', 'animate-pulse');
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitExam(true);
                }
            }, 1000);
            
            updateProgress();
        }

        function renderQuestion() {
            const container = document.getElementById('questions-container');
            const q = currentQuestions[currentQuestionIndex];
            
            let optionsHTML = '';
            q.shuffledOptions.forEach(opt => {
                const isChecked = userAnswers[q.id] === opt ? 'checked' : '';
                optionsHTML += `
                    <label class="block relative cursor-pointer group">
                        <input type="radio" name="q-${q.id}" value="${escapeHtml(opt)}" class="peer sr-only" onchange="recordAnswer(${q.id}, '${escapeHtml(opt).replace(/'/g, "\\'")}')" ${isChecked}>
                        <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all duration-200 peer-checked:bg-blue-50 peer-checked:border-blue-600">
                            <div class="w-6 h-6 rounded-full border-2 border-gray-300 mr-4 flex items-center justify-center peer-checked:border-blue-600 peer-checked:bg-blue-600">
                                <div class="w-2.5 h-2.5 bg-white rounded-full radio-dot"></div>
                            </div>
                            <span class="text-gray-700 font-medium select-none">${escapeHtml(opt)}</span>
                        </div>
                    </label>`;
            });

            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 fade-in">
                    <div class="mb-4"><span class="bg-blue-100 text-blue-700 font-bold rounded-lg px-3 py-1 text-sm">Question ${currentQuestionIndex + 1} of 15</span></div>
                    <h3 class="text-xl font-medium text-gray-900 mb-6 leading-relaxed">${escapeHtml(q.question)}</h3>
                    <div class="grid grid-cols-1 gap-3">${optionsHTML}</div>
                </div>`;
            
            document.getElementById('btn-prev').disabled = currentQuestionIndex === 0;
            if (currentQuestionIndex === currentQuestions.length - 1) {
                document.getElementById('btn-next').classList.add('hidden');
                document.getElementById('btn-submit').classList.remove('hidden');
            } else {
                document.getElementById('btn-next').classList.remove('hidden');
                document.getElementById('btn-submit').classList.add('hidden');
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        }

        function recordAnswer(qId, val) {
            userAnswers[qId] = val;
            const percentage = (Object.keys(userAnswers).length / 15) * 100;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
        }

        function updateProgress() {
            const percentage = (Object.keys(userAnswers).length / 15) * 100;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
        }

        function submitExam(forced = false) {
            clearInterval(timerInterval);
            if (!forced && Object.keys(userAnswers).length < 15) {
                if(!confirm("You haven't answered all questions. Submit anyway?")) return;
            }

            let score = 0;
            currentQuestions.forEach(q => {
                if (userAnswers[q.id] === escapeHtml(q.correctAnswerText)) score++;
            });

            const percentage = Math.round((score / 15) * 100);

            document.getElementById('view-quiz').classList.add('hidden');
            document.getElementById('timer-display').classList.add('hidden');
            document.getElementById('view-results').classList.remove('hidden');
            window.scrollTo(0, 0);

            document.getElementById('final-score').textContent = `${percentage}%`;
            document.getElementById('correct-count').textContent = `${score}/15`;
            
            const msg = document.getElementById('result-message');
            const icon = document.getElementById('score-icon-container');
            
            if (percentage >= 40) {
                msg.textContent = "Great job! You passed.";
                icon.className = "w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-4 bg-green-100 text-green-600";
                icon.innerHTML = '<i class="fas fa-trophy text-4xl"></i>';
            } else {
                msg.textContent = "Keep practicing!";
                icon.className = "w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-4 bg-red-100 text-red-600";
                icon.innerHTML = '<i class="fas fa-times text-4xl"></i>';
            }

            // Review Logic
            const reviewContainer = document.getElementById('review-container');
            reviewContainer.innerHTML = '';
            currentQuestions.forEach((q, idx) => {
                const userVal = userAnswers[q.id];
                const correctVal = escapeHtml(q.correctAnswerText);
                const isCorrect = userVal === correctVal;
                
                let badge = isCorrect 
                    ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-bold">Correct</span>'
                    : '<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full font-bold">Incorrect</span>';
                
                reviewContainer.innerHTML += `
                    <div class="bg-white rounded-lg border ${isCorrect ? 'border-green-200' : 'border-red-200'} p-4 text-left">
                        <div class="flex justify-between items-start mb-2"><span class="text-sm text-gray-500 font-mono">Q${idx + 1}</span>${badge}</div>
                        <p class="font-medium text-gray-900 mb-3">${escapeHtml(q.question)}</p>
                        <div class="text-sm space-y-1">
                            <div class="flex gap-2"><span class="text-gray-500 w-24">You:</span><span class="${isCorrect?'text-green-600':'text-red-600'} font-semibold">${userVal||'Skipped'}</span></div>
                            ${!isCorrect ? `<div class="flex gap-2"><span class="text-gray-500 w-24">Correct:</span><span class="text-green-600 font-semibold">${correctVal}</span></div>` : ''}
                        </div>
                    </div>`;
            });
        }
    </script>
</body>
</html>